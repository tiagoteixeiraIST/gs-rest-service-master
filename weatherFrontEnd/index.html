<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1">
		
		<title>Weather Challenge</title>
		<style type="text/css">
			.leaflet-container {
		        background: rgba(0,0,0,.8) !important;
		      }
		</style>

		<!-- Loading third party fonts -->
		<link href="http://fonts.googleapis.com/css?family=Roboto:300,400,700|" rel="stylesheet" type="text/css">
		<link href="fonts/font-awesome.min.css" rel="stylesheet" type="text/css">

		<!-- Loading main css file -->
		<link rel="stylesheet" href="style.css">

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		          crossorigin=""/>
				
		<!--[if lt IE 9]>
		<script src="js/ie-support/html5.js"></script>
		<script src="js/ie-support/respond.js"></script>
		<![endif]-->

	</head>


	<body>
		
		<div class="site-content">
			<div class="site-header">
				<div class="container">
					<a href="index.html" class="branding">
						<img src="images/logo.png" alt="" class="logo">
						<div class="logo-type">
							<h1 class="site-title">Wit Software</h1>
							<small class="site-description">Weather Forecast</small>
						</div>
					</a>

					<!-- Default snippet for navigation -->
					<div class="main-navigation">
						<button type="button" class="menu-toggle"><i class="fa fa-bars"></i></button>
						<ul class="menu">
							<li class="menu-item current-menu-item"><a href="index.html">Home</a></li>
<!-- 							<li class="menu-item"><a href="news.html">News</a></li>
							<li class="menu-item"><a href="live-cameras.html">Live cameras</a></li>
							<li class="menu-item"><a href="photos.html">Photos</a></li>
							<li class="menu-item"><a href="contact.html">Contact</a></li> -->
						</ul> <!-- .menu -->
					</div> <!-- .main-navigation -->

					<div class="mobile-navigation"></div>

				</div>
			</div> <!-- .site-header -->

			<div class="hero" data-bg-image="images/banner.png">
				<div class="container">
					<div class="filter" >
						<div class="quality filter-control float-right" style="background: white; color: black;">
							<label for="">Measure</label>
							<span class="select control">
								<select name="" id="measure">
									<option value="C">ºC</option>
									<option value="F">ºF</option>
								</select>
							</span>
						</div>
					</div>
					<form action="#" id="form" class="find-location">
						<input autocomplete="off" type="text" id="searchTerm"  placeholder="Find your location... (lisboa, porto, aveiro or coimbra)">
						<input type="submit" value="Find">
					</form>

			</div>
		</div>

			<div class="forecast-table" style="margin-top: 2%">
				<div class="container">
					<div class="forecast-container">
						<div class="today forecast">
							<div class="forecast-header">
								<div class="day">T</div>
								<div class="date"></div>
							</div> <!-- .forecast-header -->
							<div class="forecast-content">
								<div class="location" id="cityname"></div>
								<div class="degree">
									<div class="num" id="temp1"></div>
									<div class="forecast-icon">
										<img id="img1" alt="" width=90>
									</div>	
								</div>
								<span id="rain1"><img src="images/icon-umberella.png" alt=""></span>
								<span id="wind1"><img src="images/icon-wind.png" alt=""></span>
							</div>
						</div>
						<div class="forecast">
							<div class="forecast-header">
								<div class="day">T+1</div>
							</div> <!-- .forecast-header -->
							<div class="forecast-content">
								<div class="forecast-icon">
									<img id="img2"  alt="" width=48>
								</div>
								<div id="temp2" class="degree"></div>
							</div>
						</div>
						<div class="forecast">
							<div class="forecast-header">
								<div class="day">T+2</div>
							</div> <!-- .forecast-header -->
							<div class="forecast-content">
								<div class="forecast-icon">
									<img id="img3"  alt="" width=48>
								</div>
								<div id="temp3" class="degree"></div>
							</div>
						</div>
						<div class="forecast">
							<div class="forecast-header">
								<div class="day">T+3</div>
							</div> <!-- .forecast-header -->
							<div class="forecast-content">
								<div class="forecast-icon">
									<img id="img4"  alt="" width=48>
								</div>
								<div id="temp4" class="degree"></div>
							</div>
						</div>
						<div class="forecast">
							<div class="forecast-header">
								<div class="day">T+4</div>
							</div> <!-- .forecast-header -->
							<div class="forecast-content">
								<div class="forecast-icon">
									<img id="img5"  alt="" width=48>
								</div>
								<div id="temp5" class="degree"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<main class="main-content">
				<div class="fullwidth-block" data-bg-color="white">
					<div class="container">
						<div class="row">
							<div class="col-md-6" >
   								<div id="map" style="height: 400px"></div>
							</div>
							<div class="col-md-6">
								<canvas id="myChart" width="400" height="400"></canvas>
							</div>
						</div>
					</div>
				</div>
				</div>
			</main> <!-- .main-content -->


		</div>
		
		<script src="js/jquery-1.11.1.min.js"></script>
		<script src="js/plugins.js"></script>
		<script src="js/app.js"></script>
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
		<script src="js/heatmap.js"></script>
		<script src="js/leaflet-heatmap.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
		<script>
			var baseLayer = L.tileLayer(
		          'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
		            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
		            maxZoom: 18
		          }
		        );

			var cfg = {
		          // radius should be small ONLY if scaleRadius is true (or small radius is intended)
		          "radius": 1,
		          "maxOpacity": .8, 
		          // scales the radius based on map zoom
		          "scaleRadius": true, 
		          // if set to false the heatmap uses the global maximum for colorization
		          // if activated: uses the data maximum within the current map boundaries 
		          //   (there will always be a red spot with useLocalExtremas true)
		          "useLocalExtrema": true,
		          // which field name in your data represents the latitude - default "lat"
		          latField: 'lat',
		          // which field name in your data represents the longitude - default "lng"
		          lngField: 'lng',
		          // which field name in your data represents the data value - default "value"
		          valueField: 'count'
		        };


		        var heatmapLayer = new HeatmapOverlay(cfg);

		        var map = new L.Map('map', {
		          center: new L.LatLng(40.2045366,-8.4123607),
		          zoom: 4,
		          layers: [baseLayer, heatmapLayer]
		        });

		        
			function updateLineChart(temps){
				var ctx = document.getElementById('myChart');
				var myChart = new Chart(ctx, {
				    type: 'line',
				    data: {
				        labels: ['T', 'T+1', 'T+2', 'T+3', 'T+4'],
				        datasets: [{
				            label: 'Temperature Variation',
				            data: temps,
				            backgroundColor: [
				                'rgba(255, 99, 132, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(255, 206, 86, 0.2)',
				                'rgba(75, 192, 192, 0.2)',
				                'rgba(153, 102, 255, 0.2)',
				            ],
				            borderColor: [
				                'rgba(255, 99, 132, 1)',
				                'rgba(54, 162, 235, 1)',
				                'rgba(255, 206, 86, 1)',
				                'rgba(75, 192, 192, 1)',
				                'rgba(153, 102, 255, 1)',
				            ],
				            borderWidth: 1
				        }]
				    },
				    options: {
				        scales: {
				            yAxes: [{
				                ticks: {
				                    beginAtZero: true
				                }
				            }]
				        }
				    }
				});

			}

			function updateHeatMap(city){
				var def={lat: 40.2045, lng:-8.4123, count: 1};/*coimbra*/

				if(city=='lisboa'){
					def={lat: 38.7436883, lng:-9.1952227, count: 1};/*lisboa*/
				}
				else if(city=='porto'){
					def={lat: 41.1622023, lng:-8.6569731, count: 1};/*porto*/
				}
				else if(city=='aveiro'){
					def={lat: 40.6394116, lng:-8.6621375, count: 1};/*aveiro*/
				}

				var testData = {
		          max: 8,
		          data: [def]
		      };
		        heatmapLayer.setData(testData);

		        // make accessible for debugging
		        layer = heatmapLayer;
			}


			function updateForecast(city){
				var temps=[];

		    	$.get( "http://localhost:8080/cities/"+city+"?days=5", function( data ) {
				}).done(function(data) {
				  	parsedata=JSON.parse(data);
				  	$('#cityname').text(city);


				  	if (parsedata['error']){
					  	Swal.fire(
						  parsedata['error'],
						  '',
						  'error'
						)
				  	}
				  	else{
					  	for(var i=1;i<=5;i++){
					  		if(i==1){
							$('#rain1').text(parsedata[city][1]['rain']);
							$('#wind1').text(parsedata[city][1]['wind']);
					  		}
					  		temp=parsedata[city][i]['temp'];

							$('#temp'+i).text(parsedata[city][i]['temp']+'º');
							temps.push(parseInt(temp));
							//console.log(temps);

							if('Sunny'==parsedata[city][i]['status'])
					        	$('#img'+i).attr('src','images/icons/icon-2.svg');
							else if('Cloudy'==parsedata[city][i]['status'])
					        	$('#img'+i).attr('src','images/icons/icon-5.svg');
							else if('Rainy'==parsedata[city][i]['status'])
					        	$('#img'+i).attr('src','images/icons/icon-10.svg');
							else if('Windy'==parsedata[city][i]['status'])
					        	$('#img'+i).attr('src','images/icons/icon-8.svg');
							else if('Foggy'==parsedata[city][i]['status'])
								$('#img'+i).attr('src','images/icons/icon-7.svg');
					  	}
					  	//console.log(temps);
	    				updateLineChart(temps);
				  	}
				  })
				  .fail(function(data) {
				    Swal.fire(
					  'An error has occurred getting the weather information from the server!',
					  '',
					  'error'
					)
				  })
				  
			}

			

			$('#measure').on('change', function() { //assuming celsius is the default measure
				var measure=$( "#measure" ).val();

			  	for(var i=1;i<=5;i++){
					var current=$('#temp'+i).text().slice(0, -1);
					console.log(current);

					if(measure=='F'){
						var fahn=Math.round((parseInt(current)*1.8)+32);
						$('#temp'+i).text(fahn+'º');
					}
					else if(measure=='C'){
						var celsius=Math.round((parseInt(current)-32)/1.8);
						$('#temp'+i).text(celsius+'º');
					}

	  			}
			});

		    $(document).ready(function () {
		    	//Let's assume that coimbra is our current location
	    		temps=updateForecast('coimbra');
	    		updateHeatMap('coimbra');

		    });

			$('#form').submit(function() { 
				var city=$('#searchTerm').val();
		    	temps=updateForecast(city);
	    		updateLineChart(temps);
	    		updateHeatMap(city);

			    return false;
			});



		</script>
		
	</body>

</html>